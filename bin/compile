#!/bin/bash

# bin/compile BUILD_DIR CACHE_DIR
build_dir=$1
cache_dir=$2

indent() {
  return_status=${?:0}
  echo "-----> RETURN STATUS $return_status"
  sed -u 's/^/       /'
  return return_status
}

echo "-----> Install ruby 1.9.3 (1.9.3-p392)"
mkdir -p $build_dir/vendor
cd $build_dir/vendor
curl http://dl.dropbox.com/u/15270883/ruby-1.9.3.tgz -s -o - | tar zxf -

# add vendor binaries to the path
mkdir -p $build_dir/profile.d
cat << EOF > $build_dir/profile.d/ruby.sh
PATH="\$HOME/vendor/1.9.3-p392/bin:\$PATH"
LANG=${LANG:-en_US.UTF-8}
EOF

# bundle install
echo "-----> Install dependencies using bundle (version packaged)"
PATH="$build_dir/vendor/1.9.3-p392/bin:$PATH"
LANG=LANG:-en_US.UTF-8
bundle install --without development test --path vendor/bundle --deployment | indent
echo $? | indent
